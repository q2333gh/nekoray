# Nekoray Windows 构建指南

本文档介绍如何在 Windows 环境下构建 Nekoray 项目。

## 📋 必须准备

### 1. 系统要求
- **操作系统**: Windows 10/11 (64位)
- **磁盘空间**: 至少 10GB 可用空间（用于源码、依赖和构建产物）

### 2. 必需软件

#### Python 3.x
- **版本要求**: Python 3.7 或更高版本
- **安装方式**: 
  - 从 [python.org](https://www.python.org/downloads/) 下载安装
  - 或使用包管理器：`winget install Python.Python.3.11`
- **验证**: 运行 `python --version` 确认安装成功

#### Visual Studio (MSVC)
- **版本要求**: Visual Studio 2019 或 2022（社区版即可）
- **必需组件**: 
  - "使用 C++ 的桌面开发" 工作负载
  - MSVC 编译器工具集
  - Windows SDK
- **安装方式**: 从 [visualstudio.microsoft.com](https://visualstudio.microsoft.com/) 下载安装
- **验证**: 确保 `cl.exe` 可用（通常在 VS 的 Developer Command Prompt 中）

#### CMake
- **版本要求**: CMake 3.10 或更高版本（推荐 3.20+）
- **安装方式**:
  ```powershell
  winget install --id Kitware.CMake --source winget
  ```
- **验证**: 运行 `cmake --version` 确认安装成功

#### Git
- **版本要求**: Git 2.0 或更高版本
- **安装方式**: 从 [git-scm.com](https://git-scm.com/download/win) 下载安装
- **验证**: 运行 `git --version` 确认安装成功

#### Qt 6.5 SDK
- **版本要求**: Qt 6.5.0 或更高版本（MSVC 2019 64位版本）
- **下载地址**: 
  - 预编译包: https://github.com/MatsuriDayo/nekoray_qt_runtime/releases/download/20220503/Qt6.5.0-Windows-x86_64-VS2022-17.5.5-20230507.7z
  - 或从 Qt 官网下载: https://www.qt.io/download
- **安装位置**: 解压到项目根目录下的 `qt_lib/qt650` 目录
  ```
  nekoray/
  └── qt_lib/
      └── qt650/          # Qt SDK 解压到这里
          ├── bin/
          ├── lib/
          └── ...
  ```
- **验证**: 确认 `qt_lib/qt650/bin/qmake.exe` 存在

#### Ninja（可选，推荐）
- **说明**: 如果安装了 Ninja，构建速度会更快
- **安装方式**:
  ```powershell
  winget install --id Ninja-build.Ninja --source winget
  ```
- **验证**: 运行 `ninja --version` 确认安装成功

### 3. 网络要求
- **必需**: 稳定的互联网连接
- **用途**: 
  - 克隆 Git 仓库
  - 下载第三方依赖库（yaml-cpp, zxing-cpp, protobuf）
  - 下载资源文件（geoip.dat, geosite.dat 等）
  - 下载 nekobox_core.exe（可选）

## 🚀 构建步骤

### 步骤 1: 克隆仓库

```powershell
git clone https://github.com/MatsuriDayo/nekoray.git
cd nekoray
```

如果需要包含子模块：
```powershell
git submodule update --init --recursive
```

### 步骤 2: 准备 Qt SDK

将下载的 Qt 6.5 SDK 解压到项目根目录：

```powershell
# 假设 Qt SDK 压缩包在 Downloads 目录
# 创建目录
New-Item -ItemType Directory -Force -Path qt_lib\qt650

# 解压 Qt SDK（使用 7-Zip 或其他解压工具）
# 将解压后的内容放到 qt_lib\qt650 目录下
```

**目录结构示例**:
```
nekoray/
├── qt_lib/
│   └── qt650/
│       ├── bin/
│       │   ├── qmake.exe
│       │   ├── windeployqt.exe
│       │   └── ...
│       ├── lib/
│       └── ...
├── build_windows.py
└── ...
```

### 步骤 3: 运行构建脚本

在项目根目录执行：

```powershell
python build_windows.py
```

**构建过程说明**:
1. **检测构建环境**: 自动检测 Visual Studio、CMake、Ninja 等工具
2. **构建第三方依赖**: 
   - 自动下载并构建 yaml-cpp (master 分支)
   - 自动下载并构建 zxing-cpp (v2.0.0)
   - 自动下载并构建 protobuf (v21.4)
   - 依赖库将缓存到 `libs/deps/built` 目录
3. **配置 CMake**: 使用 Qt 6.5 和已构建的依赖库配置项目
4. **编译项目**: 使用 70% 的 CPU 核心进行并行编译
5. **部署资源**: 
   - 下载 geoip.dat, geosite.dat, geoip.db, geosite.db
   - 复制 `res/public` 目录下的资源文件
6. **下载核心组件**: 尝试从 GitHub Releases 下载 nekobox_core.exe

**构建时间**: 
- 首次构建（包含依赖编译）: 约 30-60 分钟
- 后续构建（依赖已缓存）: 约 5-15 分钟

## 📦 构建产物

构建成功后，将生成以下文件：

### 主要可执行文件

#### `nekobox.exe`
- **位置**: 项目根目录
- **说明**: 主程序可执行文件
- **大小**: 约 5-10 MB

#### `nekobox.exe` (构建目录)
- **位置**: `build/Release/nekobox.exe` 或 `build_ninja/Release/nekobox.exe`
- **说明**: 构建目录中的原始可执行文件

### 依赖库文件

#### Qt DLL 文件
- **位置**: `build/Release/` 目录
- **包含文件**:
  - `Qt6Core.dll`
  - `Qt6Gui.dll`
  - `Qt6Network.dll`
  - `Qt6Widgets.dll`
  - `Qt6Svg.dll`
  - `Qt6Pdf.dll`
  - 以及相关的插件和平台文件

#### OpenSSL DLL 文件
- **位置**: `build/Release/` 目录
- **包含文件**:
  - `libcrypto-3-x64.dll` 或 `libcrypto-1_1-x64.dll`
  - `libssl-3-x64.dll` 或 `libssl-1_1-x64.dll`

### 资源文件

#### 地理位置数据
- **位置**: `build/Release/` 目录
- **包含文件**:
  - `geoip.dat` - IP 地理位置数据库（旧格式）
  - `geosite.dat` - 域名规则数据库（旧格式）
  - `geoip.db` - IP 地理位置数据库（新格式）
  - `geosite.db` - 域名规则数据库（新格式）

#### 公共资源
- **位置**: `build/Release/` 目录
- **说明**: `res/public` 目录下的所有文件将被复制到这里

### 核心组件

#### `nekobox_core.exe`
- **位置**: `build/Release/nekobox_core.exe`
- **说明**: 核心代理引擎（如果下载成功）
- **来源**: 从 GitHub Releases 自动下载，或需要手动构建（参考 `docs/Build_Core.md`）

### 依赖库缓存

#### 第三方库
- **位置**: `libs/deps/built/`
- **包含**:
  - `lib/yaml-cpp.lib` - YAML 解析库
  - `lib/ZXing.lib` - 二维码处理库
  - `lib/libprotobuf.lib` - Protocol Buffers 库
  - `lib/libprotoc.lib` - Protocol Buffers 编译器库
  - `bin/protoc.exe` - Protocol Buffers 编译器
  - 相应的头文件和 CMake 配置文件

## ✅ 验证构建

### 检查可执行文件

```powershell
# 检查主程序
Test-Path nekobox.exe

# 检查构建目录中的文件
Get-ChildItem build\Release\nekobox.exe -ErrorAction SilentlyContinue
```

### 运行程序

```powershell
cd build\Release
.\nekobox.exe
```

如果遇到 DLL 缺失错误，确保：
1. Qt DLL 文件已正确部署（运行 `windeployqt`）
2. OpenSSL DLL 文件已复制到 Release 目录
3. 所有资源文件已下载

## 🔧 故障排除

### 问题 1: CMake 未找到
**解决方案**: 
```powershell
winget install --id Kitware.CMake --source winget
```

### 问题 2: Qt SDK 未找到
**错误信息**: `Qt directory missing at qt_lib/qt650`
**解决方案**: 确保 Qt 6.5 SDK 已解压到 `qt_lib/qt650` 目录

### 问题 3: Visual Studio 未找到
**错误信息**: `Visual Studio installation not found`
**解决方案**: 安装 Visual Studio 2019 或 2022，确保包含 C++ 开发工具

### 问题 4: 依赖构建失败
**解决方案**: 
- 检查网络连接
- 确保有足够的磁盘空间
- 查看构建日志中的具体错误信息

### 问题 5: DLL 缺失错误
**解决方案**: 
```powershell
# 手动运行 windeployqt
cd build\Release
..\..\qt_lib\qt650\bin\windeployqt.exe nekobox.exe

# 手动复制 OpenSSL DLL
Copy-Item ..\..\qt_lib\qt650\bin\libcrypto-3-x64.dll -Destination .
Copy-Item ..\..\qt_lib\qt650\bin\libssl-3-x64.dll -Destination .
```

## 📝 构建配置说明

### 并行编译设置
- 默认使用 **70%** 的 CPU 核心进行并行编译
- 可在 `build_windows.py` 的 `cmake_build()` 函数中调整

### 依赖库版本
- **yaml-cpp**: master 分支（最新）
- **zxing-cpp**: v2.0.0
- **protobuf**: v21.4
- **Qt**: 6.5.0+

### 构建选项
- **配置**: Release（发布版本）
- **生成器**: 自动检测（优先使用 Ninja，否则使用 Visual Studio）
- **外部依赖**: 自动构建并缓存

## 🔄 清理构建

如需重新构建，可清理构建产物：

```powershell
# 清理主构建目录
Remove-Item -Path build -Recurse -Force
Remove-Item -Path build_ninja -Recurse -Force

# 清理依赖缓存（可选，会重新构建依赖）
Remove-Item -Path libs\deps\built -Recurse -Force
Remove-Item -Path libs\deps\yaml-cpp -Recurse -Force
Remove-Item -Path libs\deps\zxing-cpp -Recurse -Force
Remove-Item -Path libs\deps\protobuf -Recurse -Force

# 清理根目录的可执行文件
Remove-Item -Path nekobox.exe -Force
```

## 📚 相关文档

- **核心组件构建**: 参考 `docs/Build_Core.md`
- **Linux 构建**: 参考 `docs/Build_Linux.md`
- **依赖报告**: 参考 `dep_report.md`

## 💡 提示

1. **首次构建较慢**: 首次构建需要下载和编译所有依赖库，请耐心等待
2. **使用 SSD**: 将项目放在 SSD 上可以显著提升构建速度
3. **关闭杀毒软件**: 构建过程中杀毒软件可能会影响性能
4. **保持网络畅通**: 确保能够访问 GitHub 和下载资源

---

**最后更新**: 2025-01-12  
**构建脚本版本**: `build_windows.py` (Python 3.x)
