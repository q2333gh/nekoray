# Nekoray 构建产物与周边文件

本文档描述 Windows 本地构建（`build_windows.py`）与 CI（`.github/workflows/windows-build.yml`）中产生的**构建产物**，以及**自动集成**的 proxy core、DLL、geodata 等周边文件的来源与流程。

---

## 一、最终产物目录

- **本地构建**：`build/Release/`（MSVC 生成器）或 `build_ninja/`（Ninja Multi-Config）
- **根目录**：构建结束后会把 `nekobox.exe` 再复制一份到仓库根目录
- **CI 打包**：对 `build/Release/*` 打 zip，作为 GitHub Release 附件

---

## 二、主程序（本仓库编译）

| 产物 | 说明 |
|------|------|
| `nekobox.exe` | 主 GUI 程序，由 CMake 编译 C++/Qt 代码生成，位于 `build/Release/` 或 `build_ninja/`，并复制到仓库根目录 |

---

## 三、自动集成的 Proxy Core

| 产物 | 来源 | 脚本/流程 |
|------|------|-----------|
| `nekobox_core.exe` | GitHub Releases 预编译 | 本地：`build_windows.py` 调用 `libs/download_core.py`；CI：PowerShell 内联逻辑 |

- **默认仓库**：`MatsuriDayo/nekoray` 的 **latest** release
- **获取方式**：GitHub API 取最新 release → 找到名称含 `windows` 且为 `.zip` 的 asset → 下载并解压，从中取出 `nekobox_core.exe` 放到 `build/Release/`（或等效 release 目录）
- **脚本**：`libs/download_core.py`（支持 `--dest-dir`、`--version latest|<tag>`）
- **失败时**：构建不中断，仅提示；用户需自行从 [Releases](https://github.com/MatsuriDayo/nekoray/releases) 下载并放入 release 目录

---

## 四、自动集成的 DLL 与 Qt 运行时

### 4.1 Qt 运行时（windeployqt）

- **方式**：在 `nekobox.exe` 所在目录执行 `windeployqt.exe`（来自 `qt_lib/qt650/bin` 或 CI 的 `C:\Qt\<version>\msvc2019_64\bin`）
- **效果**：自动拷贝 Qt 所需 DLL（如 `Qt6Core.dll`、`Qt6Gui.dll`、`Qt6Network.dll`、`Qt6Widgets.dll` 等）及插件到 release 目录
- **参数**（本地）：`--release --no-translations --no-compiler-runtime --no-system-d3d-compiler --no-opengl-sw --no-virtualkeyboard`
- **CI 额外清理**：删除 `translations/`、`libEGL.dll`、`libGLESv2.dll`、`Qt6Pdf.dll`

### 4.2 OpenSSL DLL

- **目标文件**：`libcrypto-3-x64.dll`、`libssl-3-x64.dll`（本地脚本仅处理这两个名称）
- **来源**：从 Qt SDK 的 `bin` 目录（如 `qt_lib/qt650/bin`）复制到 release 目录
- **实现**：`build_windows.py` 中 `copy_openssl_libraries()`；CI 中 PowerShell 会尝试多种命名（如 `libcrypto-3-x64.dll`、`libcrypto-1_1-x64.dll` 等）以兼容不同 Qt/OpenSSL 版本

---

## 五、自动下载的 Geodata 等公共资源

### 5.1 脚本与缓存

- **脚本**：`libs/download_resources.py`
- **本地**：先下载到缓存目录 `libs/deps/resources/`，再复制到 `build/Release/`（或 Ninja 的 release 目录）；CI 可直接指定 `--dest-dir build/Release`

### 5.2 Geodata 文件列表与 URL

| 文件名 | 来源 URL |
|--------|----------|
| `geoip.dat` | https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat |
| `geosite.dat` | https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat |
| `geoip.db` | https://github.com/SagerNet/sing-geoip/releases/latest/download/geoip.db |
| `geosite.db` | https://github.com/SagerNet/sing-geosite/releases/latest/download/geosite.db |

- 若目标目录已存在且大小 > 0，则跳过下载；空文件会重新下载。

### 5.3 res/public 目录

- 若存在 `res/public/`，`download_resources.py` 会将其下**所有文件**复制到 release 目录（与 geodata 同目录）
- 当前仓库中可能无此目录，属可选；若有则会在资源下载/复制阶段一并处理

---

## 六、构建时依赖的缓存（非最终产物）

以下在构建过程中使用，安装到 `libs/deps/built/`，**不会**被复制到 `build/Release/`，仅供编译/代码生成用：

| 依赖 | 用途 | 版本/来源 |
|------|------|-----------|
| yaml-cpp | 配置解析 | GitHub jbeder/yaml-cpp，master |
| zxing-cpp | 二维码 | GitHub nu-book/zxing-cpp，v2.0.0 |
| protobuf | gRPC/协议 | GitHub protocolbuffers/protobuf，v21.4；含 `protoc.exe`、lib、cmake |
| QHotkey | 全局热键 | 3rdparty 若缺失则 git clone Skycoder42/QHotkey |

缓存清单：`libs/deps/built/.cache_manifest.json`，记录各依赖版本与校验；`clean_build.py --clean-deps` 会清理依赖与清单。

---

## 七、流程顺序小结（本地 build_windows.py）

1. 准备第三方库（yaml-cpp、zxing、protobuf）、QHotkey
2. CMake 配置与编译主工程 → 生成 `nekobox.exe`
3. `copy_executable`：将 `nekobox.exe` 复制到仓库根目录
4. **download_resources**：下载 geodata 到 `libs/deps/resources/`，再复制到 release 目录；复制 `res/public`（若存在）
5. **download_core**：下载 `nekobox_core.exe` 到 release 目录
6. **deploy_qt_runtime**：windeployqt 部署 Qt DLL
7. **copy_openssl_libraries**：复制 OpenSSL DLL 到 release 目录

CI 顺序与上述逻辑一致，仅 Qt/OpenSSL 路径和 windeployqt 参数略有差异（见 `.github/workflows/windows-build.yml`）。

---

## 八、参考文件

- 构建入口：`build_windows.py`
- 资源下载：`libs/download_resources.py`
- Core 下载：`libs/download_core.py`
- 依赖与缓存说明：`dep_report.md`
- 用户向构建说明：`构建.md`
- Core 自编译：`docs/Build_Core.md`
- CI 定义：`.github/workflows/windows-build.yml`
