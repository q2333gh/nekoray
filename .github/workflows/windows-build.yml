name: Windows Qt6 CMake Build

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      QT_VERSION_MAJOR: "6"
      QT_VERSION: "6.5.3"
      QT_HOST: "windows"
      QT_TARGET: "desktop"
      QT_ARCH: "win64_msvc2019_64"
      QT_MODULES: "qtbase qtsvg qttools qttranslations"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install aqtinstall
        run: |
          pip install aqtinstall

      - name: Install Qt
        run: |
          python -m aqt install-qt ^
            %QT_HOST% %QT_TARGET% %QT_VERSION% %QT_ARCH% ^
            --modules %QT_MODULES% ^
            --outputdir C:\Qt
        shell: cmd

      - name: Configure CMake (Release, Qt6, minimal external deps)
        run: |
          set QT_ROOT=C:\Qt\%QT_VERSION%\msvc2019_64
          cmake -S . -B build ^
            -DQT_VERSION_MAJOR=%QT_VERSION_MAJOR% ^
            -DNKR_NO_GRPC=ON ^
            -DNKR_NO_YAML=ON ^
            -DNKR_NO_ZXING=ON ^
            -DNKR_NO_QHOTKEY=ON ^
            -DCMAKE_PREFIX_PATH="%QT_ROOT%"
        shell: cmd

      - name: Build
        run: |
          cmake --build build --config Release
        shell: cmd

      - name: Read nekoray version
        if: success()
        shell: pwsh
        run: |
          $v = Get-Content nekoray_version.txt -Raw
          $v = $v.Trim()
          echo "NEKORAY_VERSION=$v" >> $env:GITHUB_ENV

      - name: Package Windows release zip
        if: success() && github.event_name == 'push'
        shell: pwsh
        run: |
          $zipName = "nekoray-win64-$env:NEKORAY_VERSION-${{ github.run_number }}.zip"
          Compress-Archive -Path "build/Release/*" -DestinationPath $zipName -Force
          echo "RELEASE_ZIP=$zipName" >> $env:GITHUB_ENV

      - name: Upload nekobox artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: nekobox-windows-release
          path: |
            build/Release/nekobox.exe

      - name: Create GitHub Release for Windows build
        if: success() && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.NEKORAY_VERSION }}-${{ github.run_number }}
          name: Nekoray Windows v${{ env.NEKORAY_VERSION }} (build ${{ github.run_number }})
          draft: false
          prerelease: true
          files: |
            ${{ env.RELEASE_ZIP }}
