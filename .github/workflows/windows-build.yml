name: Windows Qt6 CMake Build

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      clean_deps:
        description: 'Clean dependencies cache'
        required: false
        type: boolean
        default: false

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      QT_VERSION_MAJOR: "6"
      QT_VERSION: "6.5.3"
      QT_HOST: "windows"
      QT_TARGET: "desktop"
      QT_ARCH: "win64_msvc2022_64"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install aqtinstall
        run: |
          pip install aqtinstall

      - name: Install MSVC compiler
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Qt
        run: |
          python -m aqt install-qt ^
            %QT_HOST% %QT_TARGET% %QT_VERSION% %QT_ARCH% ^
            --outputdir C:\Qt
        shell: cmd

      - name: Configure CMake (Release, Qt6, minimal external deps)
        run: |
          set QT_ROOT=C:\Qt\%QT_VERSION%\msvc2022_64
          cmake -S . -B build ^
            -DQT_VERSION_MAJOR=%QT_VERSION_MAJOR% ^
            -DNKR_NO_GRPC=ON ^
            -DNKR_NO_YAML=ON ^
            -DNKR_NO_ZXING=ON ^
            -DNKR_NO_QHOTKEY=ON ^
            -DCMAKE_PREFIX_PATH="%QT_ROOT%"
        shell: cmd

      - name: Build
        run: |
          cmake --build build --config Release
        shell: cmd

      - name: Get commit date for versionni
        if: success()
        shell: pwsh
        run: |
          $commitDate = git log -1 --format=%ci
          $datePart = ($commitDate -split ' ')[0]
          $dateFormatted = $datePart -replace '-', ''
          echo "COMMIT_DATE=$datePart" >> $env:GITHUB_ENV
          echo "COMMIT_DATE_FORMATTED=$dateFormatted" >> $env:GITHUB_ENV
          
          # Read base version from file
          $baseVersion = (Get-Content nekoray_version.txt -Raw).Trim()
          $versionParts = $baseVersion -split '-'
          if ($versionParts.Length -ge 2) {
            $majorVersion = $versionParts[0]
            # Use commit date instead of fixed date
            $newVersion = "$majorVersion-$datePart"
          } else {
            $newVersion = "$baseVersion-$datePart"
          }
          echo "NEKORAY_VERSION=$newVersion" >> $env:GITHUB_ENV

      - name: Deploy Qt DLLs with windeployqt
        if: success()
        shell: pwsh
        run: |
          $qtBinPath = "C:\Qt\$env:QT_VERSION\msvc2022_64\bin"
          $buildReleaseDir = "build\Release"
          Set-Location $buildReleaseDir
          
          # Run windeployqt
          & "$qtBinPath\windeployqt.exe" nekobox.exe --no-compiler-runtime --no-system-d3d-compiler --no-opengl-sw
          
          # Remove unnecessary files
          Remove-Item -Path "translations" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "libEGL.dll" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "libGLESv2.dll" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "Qt6Pdf.dll" -Force -ErrorAction SilentlyContinue
          
          Set-Location ${{ github.workspace }}

      - name: Copy OpenSSL DLLs
        if: success()
        shell: pwsh
        run: |
          $qtBinPath = "C:\Qt\$env:QT_VERSION\msvc2022_64\bin"
          $buildReleaseDir = "build\Release"
          
          # Check for OpenSSL DLLs in various possible locations
          $cryptoPaths = @(
            "$qtBinPath\libcrypto-3-x64.dll",
            "$qtBinPath\libcrypto-1_1-x64.dll",
            "$qtBinPath\libcrypto-3.dll",
            "$qtBinPath\libcrypto-1_1.dll"
          )
          $sslPaths = @(
            "$qtBinPath\libssl-3-x64.dll",
            "$qtBinPath\libssl-1_1-x64.dll",
            "$qtBinPath\libssl-3.dll",
            "$qtBinPath\libssl-1_1.dll"
          )
          
          $cryptoFound = $null
          $sslFound = $null
          
          foreach ($path in $cryptoPaths) {
            if (Test-Path $path) {
              $cryptoFound = $path
              break
            }
          }
          
          foreach ($path in $sslPaths) {
            if (Test-Path $path) {
              $sslFound = $path
              break
            }
          }
          
          if ($cryptoFound) {
            $cryptoName = Split-Path -Leaf $cryptoFound
            Copy-Item $cryptoFound -Destination "$buildReleaseDir\$cryptoName" -Force
            Write-Host "Copied OpenSSL crypto DLL: $cryptoName"
          } else {
            Write-Host "Warning: libcrypto DLL not found in Qt bin directory, skipping..."
          }
          
          if ($sslFound) {
            $sslName = Split-Path -Leaf $sslFound
            Copy-Item $sslFound -Destination "$buildReleaseDir\$sslName" -Force
            Write-Host "Copied OpenSSL ssl DLL: $sslName"
          } else {
            Write-Host "Warning: libssl DLL not found in Qt bin directory, skipping..."
          }
          
          # Check if DLLs already exist in build directory (from windeployqt)
          if (Test-Path "$buildReleaseDir\libcrypto*.dll") {
            Write-Host "OpenSSL DLLs already present from windeployqt"
          }

      - name: Download resources (geosite, geoip, etc.)
        if: success()
        shell: pwsh
        run: |
          $buildReleaseDir = "build\Release"
          python libs\download_resources.py --dest-dir $buildReleaseDir

      - name: Download nekobox_core
        if: success()
        shell: pwsh
        run: |
          $buildReleaseDir = "build\Release"
          Write-Host "Attempting to download nekobox_core.exe from MatsuriDayo/nekoray releases..."
          
          # Try to download from original MatsuriDayo/nekoray repository
          # This avoids circular dependency issues with our own releases
          $RepoOwner = "MatsuriDayo"
          $RepoName = "nekoray"
          $CoreExeName = "nekobox_core.exe"
          $TempDir = Join-Path $env:TEMP "nekoray_core_download"
          
          if (Test-Path $TempDir) {
            Remove-Item -Path $TempDir -Recurse -Force -ErrorAction SilentlyContinue
          }
          New-Item -ItemType Directory -Path $TempDir -Force | Out-Null
          
          try {
            # Get latest release from original repository
            $ReleaseApiUrl = "https://api.github.com/repos/$RepoOwner/$RepoName/releases/latest"
            Write-Host "Fetching latest release info from $RepoOwner/$RepoName..."
            $ReleaseInfo = Invoke-RestMethod -Uri $ReleaseApiUrl -UseBasicParsing -ErrorAction Stop
            
            # Find Windows release asset
            $WindowsAsset = $null
            foreach ($asset in $ReleaseInfo.assets) {
              if ($asset.name -like "*windows*" -and $asset.name -like "*.zip") {
                $WindowsAsset = $asset
                break
              }
            }
            
            if (-not $WindowsAsset) {
              throw "No Windows release zip found in latest release"
            }
            
            $DownloadUrl = $WindowsAsset.browser_download_url
            $ZipFileName = $WindowsAsset.name
            $ZipPath = Join-Path $TempDir $ZipFileName
            
            Write-Host "Downloading: $DownloadUrl"
            Invoke-WebRequest -Uri $DownloadUrl -OutFile $ZipPath -UseBasicParsing -ErrorAction Stop
            
            Write-Host "Extracting nekobox_core.exe from zip..."
            $ExtractDir = Join-Path $TempDir "extracted"
            Expand-Archive -Path $ZipPath -DestinationPath $ExtractDir -Force
            
            # Find nekobox_core.exe in extracted files
            $CoreExePath = Get-ChildItem -Path $ExtractDir -Filter $CoreExeName -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            
            if ($CoreExePath) {
              $DestExePath = Join-Path $buildReleaseDir $CoreExeName
              Copy-Item -Path $CoreExePath.FullName -Destination $DestExePath -Force
              Write-Host "Successfully downloaded nekobox_core.exe: $DestExePath"
            } else {
              throw "nekobox_core.exe not found in release zip"
            }
          } catch {
            Write-Host "Warning: Failed to download nekobox_core.exe: $_" -ForegroundColor Yellow
            Write-Host "The release zip will not include nekobox_core.exe. Users will need to download it separately." -ForegroundColor Yellow
            Write-Host "You can manually download from: https://github.com/$RepoOwner/$RepoName/releases" -ForegroundColor Yellow
          } finally {
            if (Test-Path $TempDir) {
              Remove-Item -Path $TempDir -Recurse -Force -ErrorAction SilentlyContinue
            }
          }

      - name: Package Windows release zip
        if: success() && github.event_name == 'push'
        shell: pwsh
        run: |
          $zipName = "nekoray-win64-$env:NEKORAY_VERSION-${{ github.run_number }}.zip"
          Compress-Archive -Path "build/Release/*" -DestinationPath $zipName -Force
          echo "RELEASE_ZIP=$zipName" >> $env:GITHUB_ENV

      - name: Upload nekobox artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: nekobox-windows-release
          path: |
            build/Release/nekobox.exe

      - name: Install GitHub CLI (if not available)
        if: success() && github.event_name == 'push'
        shell: pwsh
        run: |
          if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "GitHub CLI not found, installing via winget..."
            winget install --id GitHub.cli --source winget --accept-package-agreements --accept-source-agreements --silent
            # Refresh PATH
            $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          } else {
            Write-Host "GitHub CLI already available"
          }
          gh --version

      - name: Create GitHub Release for Windows build (marked as latest)
        if: success() && github.event_name == 'push'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Authenticate GitHub CLI
          echo $env:GITHUB_TOKEN | gh auth login --with-token
          
          $tagName = "v$env:NEKORAY_VERSION-${{ github.run_number }}"
          $releaseName = "Nekoray Windows v$env:NEKORAY_VERSION (build ${{ github.run_number }})"
          $releaseBody = "Automated Windows build`n`nCommit: ${{ github.sha }}`nBuild Number: ${{ github.run_number }}"
          $zipFile = $env:RELEASE_ZIP
          
          Write-Host "Creating release: $tagName"
          Write-Host "Release name: $releaseName"
          Write-Host "Asset file: $zipFile"
          
          # Create release with --latest flag to ensure it's marked as latest
          gh release create $tagName `
            --title $releaseName `
            --notes $releaseBody `
            --latest `
            $zipFile
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Successfully created release $tagName and marked it as latest"
          } else {
            Write-Host "Error: Failed to create release" -ForegroundColor Red
            exit $LASTEXITCODE
          }

  clean-build:
    runs-on: windows-latest

    env:
      QT_VERSION_MAJOR: "6"
      QT_VERSION: "6.5.3"
      QT_HOST: "windows"
      QT_TARGET: "desktop"
      QT_ARCH: "win64_msvc2019_64"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install aqtinstall
        run: |
          pip install aqtinstall

      - name: Install Qt
        run: |
          python -m aqt install-qt ^
            %QT_HOST% %QT_TARGET% %QT_VERSION% %QT_ARCH% ^
            --outputdir C:\Qt
        shell: cmd

      - name: Install MSVC compiler
        uses: ilammy/msvc-dev-cmd@v1
        with:
          toolset: 14.2
          arch: x64

      - name: Setup Qt path for build_windows.py
        shell: pwsh
        run: |
          $qtSource = "C:\Qt\$env:QT_VERSION\msvc2019_64"
          $qtDest = "qt_lib\qt650"
          
          # Create directory structure
          New-Item -ItemType Directory -Path "qt_lib" -Force | Out-Null
          
          # Create junction/symlink or copy Qt if needed
          if (-not (Test-Path $qtDest)) {
            Write-Host "Creating Qt symlink from $qtSource to $qtDest"
            # Use mklink to create a directory junction (works without admin on Windows)
            cmd /c mklink /J $qtDest $qtSource
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Symlink failed, copying Qt directory instead..."
              robocopy $qtSource $qtDest /E /NFL /NDL /NJH /NJS
            }
          } else {
            Write-Host "Qt path already exists at $qtDest"
          }

      - name: Run clean build script
        shell: pwsh
        run: |
          $cleanDepsFlag = ""
          if ("${{ github.event.inputs.clean_deps }}" -eq "true") {
            $cleanDepsFlag = "--clean-deps"
            Write-Host "Cleaning dependencies cache before build"
          }
          Write-Host "Running clean_build.py with flags: $cleanDepsFlag"
          python clean_build.py $cleanDepsFlag *> clean_build.log 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Build failed. Showing last 50 lines of log:"
            Get-Content clean_build.log -Tail 50
            exit $LASTEXITCODE
          }
        continue-on-error: false

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clean-build-log
          path: clean_build.log
          retention-days: 7

      - name: Upload nekobox artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: nekobox-clean-build
          path: |
            build/Release/nekobox.exe
