name: Windows Qt6 CMake Build

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      QT_VERSION_MAJOR: "6"
      QT_VERSION: "6.5.3"
      QT_HOST: "windows"
      QT_TARGET: "desktop"
      QT_ARCH: "win64_msvc2019_64"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install aqtinstall
        run: |
          pip install aqtinstall

      - name: Install Qt
        run: |
          python -m aqt install-qt ^
            %QT_HOST% %QT_TARGET% %QT_VERSION% %QT_ARCH% ^
            --outputdir C:\Qt
        shell: cmd

      - name: Configure CMake (Release, Qt6, minimal external deps)
        run: |
          set QT_ROOT=C:\Qt\%QT_VERSION%\msvc2019_64
          cmake -S . -B build ^
            -DQT_VERSION_MAJOR=%QT_VERSION_MAJOR% ^
            -DNKR_NO_GRPC=ON ^
            -DNKR_NO_YAML=ON ^
            -DNKR_NO_ZXING=ON ^
            -DNKR_NO_QHOTKEY=ON ^
            -DCMAKE_PREFIX_PATH="%QT_ROOT%"
        shell: cmd

      - name: Build
        run: |
          cmake --build build --config Release
        shell: cmd

      - name: Get commit date for version
        if: success()
        shell: pwsh
        run: |
          $commitDate = git log -1 --format=%ci
          $datePart = ($commitDate -split ' ')[0]
          $dateFormatted = $datePart -replace '-', ''
          echo "COMMIT_DATE=$datePart" >> $env:GITHUB_ENV
          echo "COMMIT_DATE_FORMATTED=$dateFormatted" >> $env:GITHUB_ENV
          
          # Read base version from file
          $baseVersion = (Get-Content nekoray_version.txt -Raw).Trim()
          $versionParts = $baseVersion -split '-'
          if ($versionParts.Length -ge 2) {
            $majorVersion = $versionParts[0]
            # Use commit date instead of fixed date
            $newVersion = "$majorVersion-$datePart"
          } else {
            $newVersion = "$baseVersion-$datePart"
          }
          echo "NEKORAY_VERSION=$newVersion" >> $env:GITHUB_ENV

      - name: Deploy Qt DLLs with windeployqt
        if: success()
        shell: pwsh
        run: |
          $qtBinPath = "C:\Qt\$env:QT_VERSION\msvc2019_64\bin"
          $buildReleaseDir = "build\Release"
          Set-Location $buildReleaseDir
          
          # Run windeployqt
          & "$qtBinPath\windeployqt.exe" nekobox.exe --no-compiler-runtime --no-system-d3d-compiler --no-opengl-sw
          
          # Remove unnecessary files
          Remove-Item -Path "translations" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "libEGL.dll" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "libGLESv2.dll" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "Qt6Pdf.dll" -Force -ErrorAction SilentlyContinue
          
          Set-Location ${{ github.workspace }}

      - name: Copy OpenSSL DLLs
        if: success()
        shell: pwsh
        run: |
          $qtBinPath = "C:\Qt\$env:QT_VERSION\msvc2019_64\bin"
          $buildReleaseDir = "build\Release"
          
          # Check for OpenSSL DLLs in various possible locations
          $cryptoPaths = @(
            "$qtBinPath\libcrypto-3-x64.dll",
            "$qtBinPath\libcrypto-1_1-x64.dll",
            "$qtBinPath\libcrypto-3.dll",
            "$qtBinPath\libcrypto-1_1.dll"
          )
          $sslPaths = @(
            "$qtBinPath\libssl-3-x64.dll",
            "$qtBinPath\libssl-1_1-x64.dll",
            "$qtBinPath\libssl-3.dll",
            "$qtBinPath\libssl-1_1.dll"
          )
          
          $cryptoFound = $null
          $sslFound = $null
          
          foreach ($path in $cryptoPaths) {
            if (Test-Path $path) {
              $cryptoFound = $path
              break
            }
          }
          
          foreach ($path in $sslPaths) {
            if (Test-Path $path) {
              $sslFound = $path
              break
            }
          }
          
          if ($cryptoFound) {
            $cryptoName = Split-Path -Leaf $cryptoFound
            Copy-Item $cryptoFound -Destination "$buildReleaseDir\$cryptoName" -Force
            Write-Host "Copied OpenSSL crypto DLL: $cryptoName"
          } else {
            Write-Host "Warning: libcrypto DLL not found in Qt bin directory, skipping..."
          }
          
          if ($sslFound) {
            $sslName = Split-Path -Leaf $sslFound
            Copy-Item $sslFound -Destination "$buildReleaseDir\$sslName" -Force
            Write-Host "Copied OpenSSL ssl DLL: $sslName"
          } else {
            Write-Host "Warning: libssl DLL not found in Qt bin directory, skipping..."
          }
          
          # Check if DLLs already exist in build directory (from windeployqt)
          if (Test-Path "$buildReleaseDir\libcrypto*.dll") {
            Write-Host "OpenSSL DLLs already present from windeployqt"
          }

      - name: Download resources (geosite, geoip, etc.)
        if: success()
        shell: pwsh
        run: |
          $buildReleaseDir = "build\Release"
          & powershell -ExecutionPolicy Bypass -File "libs\download_resources.ps1" -DestDir $buildReleaseDir

      - name: Package Windows release zip
        if: success() && github.event_name == 'push'
        shell: pwsh
        run: |
          $zipName = "nekoray-win64-$env:NEKORAY_VERSION-${{ github.run_number }}.zip"
          Compress-Archive -Path "build/Release/*" -DestinationPath $zipName -Force
          echo "RELEASE_ZIP=$zipName" >> $env:GITHUB_ENV

      - name: Upload nekobox artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: nekobox-windows-release
          path: |
            build/Release/nekobox.exe

      - name: Create GitHub Release for Windows build
        if: success() && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.NEKORAY_VERSION }}-${{ github.run_number }}
          name: Nekoray Windows v${{ env.NEKORAY_VERSION }} (build ${{ github.run_number }})
          draft: false
          prerelease: true
          files: |
            ${{ env.RELEASE_ZIP }}
